(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6498],{95:(e,t,a)=>{Promise.resolve().then(a.bind(a,8466))},8466:(e,t,a)=>{"use strict";a.d(t,{default:()=>I});var s=a(5155),n=a(2115),r=a(8482),i=a(7168),c=a(9852),l=a(2714),o=a(9954),d=a(8145),m=a(4964),u=a(88),h=a(9397),p=a(1243),x=a(2713),g=a(646),y=a(4186),f=a(4213),j=a(1788),v=a(3717),b=a(5880),w=a(9302),N=a(5690),C=a(4616),A=a(3904),S=a(381),k=a(5525),$=a(2525),M=a(9869),T=a(1539),_=a(7271),q=a(8011);class B{constructor(){this.connections=new Map,this.providers=new Map,this.migrations=[],this.activeConnection=null,this.loadConnections(),this.loadMigrations()}async addConnection(e){let t=`conn_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,a={...e,id:t,isConnected:!1};return this.connections.set(t,a),await this.saveConnections(),t}async testConnection(e){let t=this.connections.get(e);if(!t)return{success:!1,message:"Connection not found"};try{let a=await this.getProvider(t.type),s=await a.testConnection(t.config);return s.success&&(t.isConnected=!0,t.lastConnected=new Date().toISOString(),t.metadata=s.metadata,this.connections.set(e,t),await this.saveConnections()),s}catch(e){return{success:!1,message:`خطأ في الاتصال: ${e.message}`}}}async setActiveConnection(e){let t=this.connections.get(e);if(!t)throw Error("Connection not found");if(!t.isConnected){let t=await this.testConnection(e);if(!t.success)throw Error(`Cannot activate disconnected database: ${t.message}`)}if(this.activeConnection){let e=this.connections.get(this.activeConnection);e&&(e.isActive=!1,this.connections.set(this.activeConnection,e))}t.isActive=!0,this.connections.set(e,t),this.activeConnection=e,await this.saveConnections(),await this.autoSetupDatabase(e)}async autoSetupDatabase(e){let t=this.connections.get(e);if(!t)throw Error("Connection not found");let a=await this.getProvider(t.type),s=[],n=!1,r=!1,i=!1;try{let c=await a.getDatabaseStatus(t.config);return c.isEmpty?(n=!0,s.push("إنشاء مخطط قاعدة البيانات"),s.push("إدراج البيانات الافتراضية"),await this.createDatabaseSchema(e),await this.seedDefaultData(e)):c.hasIncompatibleSchema?(i=!0,r=!0,s.push("إنشاء نسخة احتياطية"),s.push("هجرة المخطط"),s.push("نقل البيانات")):c.hasOldSchema?(i=!0,r=!0,s.push("إنشاء نسخة احتياطية"),s.push("تحديث المخطط")):s.push("قاعدة البيانات جاهزة للاستخدام"),n&&(await this.migrateFromCurrentSystem(e),s.push("نقل البيانات من النظام الحالي")),{setupRequired:n,actions:s,backupRecommended:r,migrationRequired:i}}catch(e){throw Error(`فشل في إعداد قاعدة البيانات: ${e.message}`)}}async createDatabaseSchema(e){let t=this.connections.get(e);if(!t)throw Error("Connection not found");let a=await this.getProvider(t.type),s=this.getSystemSchema();for(let e of s.tables)await a.createTable(t.config,e);for(let e of s.indexes)await a.createIndex(t.config,e);for(let e of s.relations)await a.createRelation(t.config,e)}getSystemSchema(){return{tables:[{name:"services",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"name",type:"varchar",required:!0},{name:"nameAr",type:"varchar",required:!0},{name:"description",type:"text"},{name:"descriptionAr",type:"text"},{name:"price",type:"decimal",required:!0},{name:"duration",type:"integer"},{name:"category",type:"varchar"},{name:"isActive",type:"boolean",default:!0},{name:"imageUrl",type:"varchar"},{name:"features",type:"json"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]},{name:"customers",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"name",type:"varchar",required:!0},{name:"email",type:"varchar",unique:!0},{name:"phone",type:"varchar",required:!0},{name:"address",type:"text"},{name:"district",type:"varchar"},{name:"city",type:"varchar",default:"جدة"},{name:"coordinates",type:"json"},{name:"preferences",type:"json"},{name:"isActive",type:"boolean",default:!0},{name:"totalBookings",type:"integer",default:0},{name:"totalSpent",type:"decimal",default:0},{name:"rating",type:"decimal"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]},{name:"bookings",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"customerId",type:"varchar",required:!0},{name:"serviceId",type:"varchar",required:!0},{name:"status",type:"varchar",required:!0},{name:"scheduledDate",type:"date",required:!0},{name:"scheduledTime",type:"time",required:!0},{name:"duration",type:"integer"},{name:"price",type:"decimal",required:!0},{name:"address",type:"text",required:!0},{name:"district",type:"varchar"},{name:"coordinates",type:"json"},{name:"notes",type:"text"},{name:"specialRequests",type:"text"},{name:"assignedTo",type:"varchar"},{name:"completedAt",type:"timestamp"},{name:"rating",type:"integer"},{name:"review",type:"text"},{name:"paymentStatus",type:"varchar",default:"pending"},{name:"paymentMethod",type:"varchar"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]},{name:"users",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"email",type:"varchar",unique:!0,required:!0},{name:"username",type:"varchar",unique:!0,required:!0},{name:"passwordHash",type:"varchar",required:!0},{name:"name",type:"varchar",required:!0},{name:"role",type:"varchar",required:!0},{name:"permissions",type:"json"},{name:"isActive",type:"boolean",default:!0},{name:"lastLoginAt",type:"timestamp"},{name:"preferences",type:"json"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]},{name:"messages",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"customerId",type:"varchar"},{name:"senderName",type:"varchar",required:!0},{name:"senderEmail",type:"varchar",required:!0},{name:"senderPhone",type:"varchar"},{name:"subject",type:"varchar",required:!0},{name:"message",type:"text",required:!0},{name:"serviceType",type:"varchar"},{name:"priority",type:"varchar",default:"medium"},{name:"status",type:"varchar",default:"unread"},{name:"assignedTo",type:"varchar"},{name:"response",type:"text"},{name:"respondedAt",type:"timestamp"},{name:"respondedBy",type:"varchar"},{name:"source",type:"varchar",default:"contact_form"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]},{name:"notifications",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"type",type:"varchar",required:!0},{name:"title",type:"varchar",required:!0},{name:"titleAr",type:"varchar",required:!0},{name:"message",type:"text",required:!0},{name:"messageAr",type:"text",required:!0},{name:"userId",type:"varchar"},{name:"isRead",type:"boolean",default:!1},{name:"priority",type:"varchar",default:"medium"},{name:"category",type:"varchar"},{name:"categoryAr",type:"varchar"},{name:"data",type:"json"},{name:"channels",type:"json"},{name:"sentAt",type:"timestamp"},{name:"readAt",type:"timestamp"},{name:"createdAt",type:"timestamp",default:"now()"}]},{name:"company_settings",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"key",type:"varchar",unique:!0,required:!0},{name:"value",type:"json",required:!0},{name:"category",type:"varchar"},{name:"description",type:"text"},{name:"isPublic",type:"boolean",default:!1},{name:"updatedBy",type:"varchar"},{name:"createdAt",type:"timestamp",default:"now()"},{name:"updatedAt",type:"timestamp",default:"now()"}]}],indexes:[{table:"bookings",columns:["customerId"]},{table:"bookings",columns:["serviceId"]},{table:"bookings",columns:["status"]},{table:"bookings",columns:["scheduledDate"]},{table:"messages",columns:["customerId"]},{table:"messages",columns:["status"]},{table:"messages",columns:["priority"]},{table:"notifications",columns:["userId"]},{table:"notifications",columns:["isRead"]},{table:"notifications",columns:["type"]},{table:"company_settings",columns:["key"]},{table:"company_settings",columns:["category"]}],relations:[{table:"bookings",column:"customerId",references:{table:"customers",column:"id"},onDelete:"cascade"},{table:"bookings",column:"serviceId",references:{table:"services",column:"id"},onDelete:"cascade"},{table:"messages",column:"customerId",references:{table:"customers",column:"id"},onDelete:"set null"}]}}async seedDefaultData(e){let t=this.connections.get(e);if(!t)throw Error("Connection not found");let a=await this.getProvider(t.type);for(let[e,s]of Object.entries(await this.loadDefaultData()))Array.isArray(s)&&s.length>0&&await a.insertBatch(t.config,e,s)}async loadDefaultData(){try{let e={};for(let t of["services","customers","bookings","users","messages","notifications","company-settings"])try{let a=await fetch(`/data/${t}.json`);if(a.ok){let s=await a.json();e[t.replace("-","_")]=Array.isArray(s)?s:[s]}}catch(e){console.warn(`تعذر تحميل ملف البيانات: ${t}.json`)}return e}catch(e){return console.error("خطأ في تحميل البيانات الافتراضية:",e),{}}}async migrateFromCurrentSystem(e){let t=this.connections.get(e);if(!t)throw Error("Connection not found");let a=await this.getProvider("json"),s=await this.getProvider(t.type);try{for(let e of["services","customers","bookings","users","messages","notifications"])try{let n=await a.findAll({},e);n&&n.length>0&&await s.insertBatch(t.config,e,n)}catch(t){console.warn(`تعذر نقل بيانات الجدول: ${e}`,t)}}catch(e){console.error("خطأ في نقل البيانات:",e)}}async createBackup(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=this.connections.get(e);if(!a)throw Error("Connection not found");let s=await this.getProvider(a.type),n={id:`backup_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,name:t.name||`نسخة احتياطية ${new Date().toLocaleString("ar")}`,source:a,createdAt:new Date().toISOString(),size:0,format:"json",compressed:t.compressed||!1,tables:[],recordCount:0,checksum:""};try{let e=await s.createBackup(a.config,{includeTables:t.includeTables,excludeTables:t.excludeTables}),r=JSON.stringify(e,null,2);return n.size=new Blob([r]).size,n.tables=Object.keys(e),n.recordCount=Object.values(e).reduce((e,t)=>e+(Array.isArray(t)?t.length:0),0),n.checksum=await this.generateChecksum(r),await this.saveBackupMetadata(n),n}catch(e){throw Error(`فشل في إنشاء النسخة الاحتياطية: ${e.message}`)}}async restoreBackup(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=await this.getBackupMetadata(e),n=this.connections.get(t);if(!s||!n)throw Error("Backup or connection not found");let r=await this.getProvider(n.type);try{let t=await this.loadBackupData(e),i=JSON.stringify(t);if(await this.generateChecksum(i)!==s.checksum)throw Error("البيانات المستعادة لا تطابق المجموع الاختباري");for(let[e,s]of Object.entries(t))(!a.includeTables||a.includeTables.includes(e))&&!(a.excludeTables&&a.excludeTables.includes(e))&&Array.isArray(s)&&s.length>0&&(a.overwriteExisting&&await r.truncateTable(n.config,e),await r.insertBatch(n.config,e,s))}catch(e){throw Error(`فشل في استعادة النسخة الاحتياطية: ${e.message}`)}}async getProvider(e){if(!this.providers.has(e)){let{createProvider:t}=await a.e(3772).then(a.bind(a,3772)),s=t(e);this.providers.set(e,s)}return this.providers.get(e)}async generateChecksum(e){let t=new TextEncoder().encode(e);return Array.from(new Uint8Array(await crypto.subtle.digest("SHA-256",t))).map(e=>e.toString(16).padStart(2,"0")).join("")}async saveConnections(){let e=Array.from(this.connections.values());localStorage.setItem("database-connections",JSON.stringify(e))}loadConnections(){let e=localStorage.getItem("database-connections");if(e)try{let t=JSON.parse(e);this.connections.clear(),t.forEach(e=>{this.connections.set(e.id,e),e.isActive&&(this.activeConnection=e.id)})}catch(e){console.error("خطأ في تحميل اتصالات قاعدة البيانات:",e)}}async saveBackupMetadata(e){let t=this.getBackups();t.push(e),localStorage.setItem("database-backups",JSON.stringify(t))}async getBackupMetadata(e){return this.getBackups().find(t=>t.id===e)||null}getBackups(){let e=localStorage.getItem("database-backups");if(e)try{return JSON.parse(e)}catch(e){console.error("خطأ في تحميل النسخ الاحتياطية:",e)}return[]}async loadBackupData(e){return{}}loadMigrations(){this.migrations=[]}getConnections(){return Array.from(this.connections.values())}getActiveConnection(){return this.activeConnection&&this.connections.get(this.activeConnection)||null}async deleteConnection(e){this.activeConnection===e&&(this.activeConnection=null),this.connections.delete(e),await this.saveConnections()}getBackupsList(){return this.getBackups()}async deleteBackup(e){let t=this.getBackups().filter(t=>t.id!==e);localStorage.setItem("database-backups",JSON.stringify(t))}}let E=new B;class D{constructor(e){this.migrations=new Map,this.appliedMigrations=new Set,this.dbManager=e,this.loadMigrations()}async compareSchemas(e){let t=this.dbManager.getConnections().find(t=>t.id===e);if(!t)throw Error("Connection not found");let a=await this.getProvider(t.type),s=await a.getSchema(t.config),n=this.getExpectedSchema();return this.performSchemaComparison(s,n)}performSchemaComparison(e,t){let a={missingTables:[],extraTables:[],differentTables:[],missingIndexes:[],extraIndexes:[],missingRelations:[],extraRelations:[]},s=new Set(e.tables.map(e=>e.name)),n=new Set(t.tables.map(e=>e.name));for(let e of t.tables)s.has(e.name)||a.missingTables.push(e.name);for(let t of e.tables)n.has(t.name)||a.extraTables.push(t.name);for(let s of t.tables){let t=e.tables.find(e=>e.name===s.name);if(t){let e=this.compareTableStructure(t,s);(e.missingColumns.length>0||e.extraColumns.length>0||e.differentColumns.length>0)&&a.differentTables.push(e)}}let r=new Set(e.indexes.map(e=>`${e.table}.${e.columns.join(",")}`)),i=new Set(t.indexes.map(e=>`${e.table}.${e.columns.join(",")}`));for(let e of t.indexes){let t=`${e.table}.${e.columns.join(",")}`;r.has(t)||a.missingIndexes.push(t)}for(let t of e.indexes){let e=`${t.table}.${t.columns.join(",")}`;i.has(e)||a.extraIndexes.push(e)}return a}compareTableStructure(e,t){let a=new Map(e.columns.map(e=>[e.name,e])),s=new Map(t.columns.map(e=>[e.name,e])),n={tableName:t.name,missingColumns:[],extraColumns:[],differentColumns:[]};for(let[e,t]of s)a.has(e)||n.missingColumns.push(e);for(let[e,t]of a)s.has(e)||n.extraColumns.push(e);for(let[e,t]of s){let s=a.get(e);s&&s.type!==t.type&&n.differentColumns.push({columnName:e,currentType:s.type,expectedType:t.type})}return n}async createMigrationPlan(e,t){let a=await this.compareSchemas(e),s=await this.getCurrentSchemaVersion(e),n=t||this.getLatestSchemaVersion(),r=`migration_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i=[],c=[],l="low",o=5;if(a.missingTables.length>0&&(i.push(this.createTableCreationMigration(a.missingTables)),o+=2*a.missingTables.length),a.differentTables.length>0){let e=this.createSchemaUpdateMigration(a.differentTables);for(let t of(i.push(e),o+=3*a.differentTables.length,a.differentTables))t.extraColumns.length>0&&(c.push(`سيتم حذف الأعمدة الإضافية في الجدول ${t.tableName}`),l="low"===l?"medium":l),t.differentColumns.length>0&&(c.push(`سيتم تغيير نوع البيانات في الجدول ${t.tableName}`),l="low"===l?"high":l)}if(a.missingIndexes.length>0&&(i.push(this.createIndexCreationMigration(a.missingIndexes)),o+=a.missingIndexes.length),a.missingRelations.length>0&&(i.push(this.createRelationCreationMigration(a.missingRelations)),o+=a.missingRelations.length),await this.needsDataMigration(e,s,n)){let t=await this.createDataMigration(e,s,n);i.push(t),o+=10,l="high",c.push("سيتم نقل البيانات الموجودة - قد يستغرق وقتاً أطول")}return{id:r,name:`ترقية المخطط من ${s} إلى ${n}`,description:`هجرة قاعدة البيانات لتطبيق آخر التحديثات والتحسينات`,fromVersion:s,toVersion:n,migrations:i,estimatedTime:o,riskLevel:l,backupRequired:"low"!==l,reversible:"critical"!==l,warnings:c,dependencies:[]}}async executeMigrationPlan(e,t){let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=await this.getMigrationPlan(t);if(!s)throw Error("Migration plan not found");let n={success:!1,executedSteps:[],failedSteps:[],backupId:void 0,rollbackAvailable:!1,errors:[]};try{if(a.createBackup||s.backupRequired)try{n.backupId=(await this.dbManager.createBackup(e,{name:`قبل الهجرة إلى ${s.toVersion}`,compressed:!0})).id,n.rollbackAvailable=!0}catch(e){if(n.errors.push(`فشل في إنشاء النسخة الاحتياطية: ${e.message}`),!a.continueOnError)return n}for(let t of s.migrations)try{a.dryRun?n.executedSteps.push(`[محاكاة] ${t.name}`):(await this.executeMigration(e,t),await this.markMigrationAsApplied(t.id),n.executedSteps.push(t.name))}catch(e){if(n.failedSteps.push(t.name),n.errors.push(`${t.name}: ${e.message}`),!a.continueOnError)break}n.success=0===n.failedSteps.length,n.success&&!a.dryRun&&await this.updateSchemaVersion(e,s.toVersion)}catch(e){n.errors.push(`خطأ عام في الهجرة: ${e.message}`)}return n}async executeMigration(e,t){let a=this.dbManager.getConnections().find(t=>t.id===e);if(!a)throw Error("Connection not found");let s=await this.getProvider(a.type);for(let e of t.steps)await this.executeMigrationStep(s,a.config,e)}async executeMigrationStep(e,t,a){switch(a.type){case"create_table":await e.createTable(t,a.data);break;case"alter_table":case"update_data":case"custom":a.query&&await e.executeQuery(t,a.query);break;case"insert_data":a.data&&await e.insertBatch(t,a.target,a.data);break;default:throw Error(`نوع خطوة الهجرة غير مدعوم: ${a.type}`)}}createTableCreationMigration(e){let t=this.getExpectedSchema(),a=[];for(let s of e){let e=t.tables.find(e=>e.name===s);e&&a.push({id:`create_table_${s}`,name:`إنشاء الجدول ${s}`,type:"create_table",target:s,data:e,reversible:!0})}return{id:`create_tables_${Date.now()}`,version:"1.0.0",name:"إنشاء الجداول المفقودة",description:`إنشاء ${e.length} جدول مفقود`,steps:a,applied:!1,rollbackSteps:a.map(e=>({...e,type:"custom",query:`DROP TABLE IF EXISTS ${e.target}`}))}}createSchemaUpdateMigration(e){let t=[];for(let a of e){for(let e of a.missingColumns)t.push({id:`add_column_${a.tableName}_${e}`,name:`إضافة العمود ${e} إلى ${a.tableName}`,type:"alter_table",target:a.tableName,query:this.generateAddColumnQuery(a.tableName,e),reversible:!0});for(let e of a.differentColumns)t.push({id:`modify_column_${a.tableName}_${e.columnName}`,name:`تعديل العمود ${e.columnName} في ${a.tableName}`,type:"alter_table",target:a.tableName,query:this.generateModifyColumnQuery(a.tableName,e),reversible:!0})}return{id:`schema_update_${Date.now()}`,version:"1.0.0",name:"تحديث مخطط الجداول",description:`تحديث ${e.length} جدول`,steps:t,applied:!1}}createIndexCreationMigration(e){let t=e.map(e=>({id:`create_index_${e.replace(/[^a-zA-Z0-9]/g,"_")}`,name:`إنشاء الفهرس ${e}`,type:"custom",target:e,query:this.generateCreateIndexQuery(e),reversible:!0}));return{id:`create_indexes_${Date.now()}`,version:"1.0.0",name:"إنشاء الفهارس المفقودة",description:`إنشاء ${e.length} فهرس`,steps:t,applied:!1}}createRelationCreationMigration(e){let t=e.map(e=>({id:`create_relation_${e.replace(/[^a-zA-Z0-9]/g,"_")}`,name:`إنشاء العلاقة ${e}`,type:"custom",target:e,query:this.generateCreateRelationQuery(e),reversible:!0}));return{id:`create_relations_${Date.now()}`,version:"1.0.0",name:"إنشاء العلاقات المفقودة",description:`إنشاء ${e.length} علاقة`,steps:t,applied:!1}}async createDataMigration(e,t,a){let s=[];return"1.0.0"===t&&"2.0.0"===a&&s.push({id:"migrate_customer_data_v2",name:"ترقية بيانات العملاء إلى الإصدار 2.0",type:"custom",target:"customers",query:"UPDATE customers SET preferences = '{}' WHERE preferences IS NULL",reversible:!1}),{id:`data_migration_${t}_to_${a}`,version:a,name:`نقل البيانات من ${t} إلى ${a}`,description:"ترقية البيانات الموجودة للتوافق مع المخطط الجديد",steps:s,applied:!1}}async getProvider(e){let{createProvider:t}=await a.e(3772).then(a.bind(a,3772));return t(e)}getExpectedSchema(){return{tables:[{name:"services",columns:[{name:"id",type:"varchar",primaryKey:!0},{name:"name",type:"varchar",required:!0},{name:"nameAr",type:"varchar",required:!0},{name:"description",type:"text"},{name:"price",type:"decimal",required:!0},{name:"category",type:"varchar"},{name:"isActive",type:"boolean",default:!0},{name:"createdAt",type:"timestamp",default:"now()"}]}],indexes:[{table:"bookings",columns:["customerId"]},{table:"bookings",columns:["serviceId"]}],relations:[]}}async getCurrentSchemaVersion(e){try{let t=this.dbManager.getConnections().find(t=>t.id===e);if(!t)return"0.0.0";let a=await this.getProvider(t.type);return await a.getSchemaVersion?.(t.config)||"1.0.0"}catch(e){return"0.0.0"}}getLatestSchemaVersion(){return"2.1.0"}async needsDataMigration(e,t,a){return t.split(".")[0]!==a.split(".")[0]}async markMigrationAsApplied(e){this.appliedMigrations.add(e)}async updateSchemaVersion(e,t){let a=this.dbManager.getConnections().find(t=>t.id===e);if(a)try{let e=await this.getProvider(a.type);await e.setSchemaVersion?.(a.config,t)}catch(e){console.warn("تعذر تحديث إصدار المخطط:",e)}}generateAddColumnQuery(e,t){return`ALTER TABLE ${e} ADD COLUMN ${t} VARCHAR(255)`}generateModifyColumnQuery(e,t){return`ALTER TABLE ${e} MODIFY COLUMN ${t.columnName} ${t.expectedType}`}generateCreateIndexQuery(e){let[t,a]=e.split(".");return`CREATE INDEX idx_${t}_${a.replace(",","_")} ON ${t} (${a})`}generateCreateRelationQuery(e){return`-- Create relation: ${e}`}loadMigrations(){}async getMigrationPlan(e){return null}async getMigrations(){return Array.from(this.migrations.values())}async rollbackMigration(e){let t=this.migrations.get(e);if(!t||!t.rollbackSteps)throw Error("Migration not found or not reversible")}}function I(){let{t:e}=(0,_.B)(),t=(0,q.lk)(),[a,B]=(0,n.useState)([]),[I,R]=(0,n.useState)(null),[P,L]=(0,n.useState)([]),[O]=(0,n.useState)(()=>new D(E)),[V,Z]=(0,n.useState)(!1),[z,J]=(0,n.useState)(null),[W,U]=(0,n.useState)(null),[F,K]=(0,n.useState)(!1),[Q,X]=(0,n.useState)(!1),[H,G]=(0,n.useState)({name:"",type:"supabase",config:{}}),[Y,ee]=(0,n.useState)({totalRecords:0,totalTables:0,dbSize:"0 MB",schemaVersion:"1.0.0",uptime:"0h"}),[et,ea]=(0,n.useState)(null),[es,en]=(0,n.useState)(null);(0,n.useEffect)(()=>{er(),ec(),ei()},[]),(0,n.useEffect)(()=>{I&&(el(),eg())},[I]);let er=()=>{B(E.getConnections())},ei=()=>{R(E.getActiveConnection())},ec=()=>{L(E.getBackupsList())},el=async()=>{if(I)try{ee({totalRecords:1250,totalTables:7,dbSize:"15.6 MB",lastBackup:"2024-01-15T10:30:00Z",schemaVersion:"2.0.1",uptime:"15 أيام"})}catch(e){console.error("خطأ في تحميل إحصائيات قاعدة البيانات:",e)}},eo=async()=>{try{await E.addConnection(H),t.success("تم الإضافة","تم إضافة الاتصال بنجاح"),G({name:"",type:"supabase",config:{}}),Z(!1),er()}catch(e){t.error("خطأ في الإضافة",e.message)}},ed=async e=>{U(e);try{let a=await E.testConnection(e);a.success?t.success("نجح الاتصال","تم الاتصال بقاعدة البيانات بنجاح"):t.error("فشل الاتصال",a.message),er()}catch(e){t.error("خطأ في الاختبار",e.message)}finally{U(null)}},em=async e=>{try{let a=await E.setActiveConnection(e);t.success("تم التفعيل","تم تفعيل قاعدة البيانات بنجاح"),a.setupRequired&&t.info("إعداد قاعدة البيانات",`تم تنفيذ: ${a.actions.join(", ")}`),er(),ei()}catch(e){t.error("خطأ في التفعيل",e.message)}},eu=async e=>{if(window.confirm("هل أنت متأكد من حذف هذا الاتصال؟"))try{await E.deleteConnection(e),t.success("تم الحذف","تم حذف الاتصال بنجاح"),er(),ei()}catch(e){t.error("خطأ في الحذف",e.message)}},eh=async()=>{if(!I)return void t.error("خطأ","لا يوجد اتصال نشط");K(!0);try{await E.createBackup(I.id,{compressed:!0}),t.success("تم الإنشاء","تم إنشاء النسخة الاحتياطية بنجاح"),ec()}catch(e){t.error("خطأ في النسخ الاحتياطي",e.message)}finally{K(!1)}},ep=async e=>{if(!I)return void t.error("خطأ","لا يوجد اتصال نشط");if(window.confirm("هل أنت متأكد من استعادة هذه النسخة الاحتياطية؟ سيتم استبدال البيانات الحالية."))try{await E.restoreBackup(e,I.id,{overwriteExisting:!0}),t.success("تم الاستعادة","تم استعادة النسخة الاحتياطية بنجاح"),el()}catch(e){t.error("خطأ في الاستعادة",e.message)}},ex=async e=>{if(window.confirm("هل أنت متأكد من حذف هذه النسخة الاحتياطية؟"))try{await E.deleteBackup(e),t.success("تم الحذف","تم حذف النسخة الاحتياطية"),ec()}catch(e){t.error("خطأ في الحذف",e.message)}},eg=async()=>{if(I)try{let e=await O.compareSchemas(I.id);if(ea(e),e.missingTables.length>0||e.differentTables.length>0||e.missingIndexes.length>0){let e=await O.createMigrationPlan(I.id);en(e)}else en(null)}catch(e){console.error("خطأ في فحص المخطط:",e)}},ey=async()=>{if(I&&es){X(!0);try{let e=await O.executeMigrationPlan(I.id,es.id,{createBackup:es.backupRequired,dryRun:!1,continueOnError:!1});e.success?(t.success("نجحت الهجرة","تم تطبيق جميع التحديثات بنجاح"),en(null),ea(null),el()):t.error("فشلت الهجرة",`فشل في: ${e.failedSteps.join(", ")}`)}catch(e){t.error("خطأ في الهجرة",e.message)}finally{X(!1)}}},ef=e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]};return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h1",{className:"text-3xl font-bold",children:"إدارة قواعد البيانات"}),(0,s.jsx)("p",{className:"text-muted-foreground",children:"إدارة الاتصالات والنسخ الاحتياطي والهجرة"})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(i.$,{onClick:()=>Z(!0),children:[(0,s.jsx)(C.A,{className:"w-4 h-4 mr-2"}),"اتصال جديد"]}),I&&(0,s.jsxs)(i.$,{onClick:eh,disabled:F,children:[F?(0,s.jsx)(A.A,{className:"w-4 h-4 mr-2 animate-spin"}):(0,s.jsx)(j.A,{className:"w-4 h-4 mr-2"}),"نسخة احتياطية"]})]})]}),I&&(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[(0,s.jsx)(r.Zp,{children:(0,s.jsx)(r.Wu,{className:"pt-6",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(b.A,{className:"w-4 h-4 text-blue-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-2xl font-bold",children:Y.totalRecords.toLocaleString()}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"إجمالي السجلات"})]})]})})}),(0,s.jsx)(r.Zp,{children:(0,s.jsx)(r.Wu,{className:"pt-6",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(x.A,{className:"w-4 h-4 text-green-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-2xl font-bold",children:Y.totalTables}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"الجداول"})]})]})})}),(0,s.jsx)(r.Zp,{children:(0,s.jsx)(r.Wu,{className:"pt-6",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(h.A,{className:"w-4 h-4 text-purple-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-2xl font-bold",children:Y.dbSize}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"حجم قاعدة البيانات"})]})]})})}),(0,s.jsx)(r.Zp,{children:(0,s.jsx)(r.Wu,{className:"pt-6",children:(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)(y.A,{className:"w-4 h-4 text-orange-500"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-2xl font-bold",children:Y.uptime}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"وقت التشغيل"})]})]})})})]}),(0,s.jsxs)(m.tU,{defaultValue:"connections",className:"space-y-4",children:[(0,s.jsxs)(m.j7,{className:"grid w-full grid-cols-4",children:[(0,s.jsxs)(m.Xi,{value:"connections",children:[(0,s.jsx)(w.A,{className:"w-4 h-4 mr-2"}),"الاتصالات"]}),(0,s.jsxs)(m.Xi,{value:"backups",children:[(0,s.jsx)(j.A,{className:"w-4 h-4 mr-2"}),"النسخ الاحتياطي"]}),(0,s.jsxs)(m.Xi,{value:"migration",children:[(0,s.jsx)(T.A,{className:"w-4 h-4 mr-2"}),"الهجرة"]}),(0,s.jsxs)(m.Xi,{value:"settings",children:[(0,s.jsx)(S.A,{className:"w-4 h-4 mr-2"}),"الإعدادات"]})]}),(0,s.jsx)(m.av,{value:"connections",children:(0,s.jsxs)("div",{className:"space-y-4",children:[a.map(e=>(0,s.jsx)(r.Zp,{children:(0,s.jsxs)(r.Wu,{className:"pt-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{className:"flex items-center space-x-4",children:[(e=>{switch(e){case"supabase":return(0,s.jsx)(f.A,{className:"w-5 h-5 text-green-500"});case"mongodb":return(0,s.jsx)(f.A,{className:"w-5 h-5 text-green-600"});case"firebase":return(0,s.jsx)(f.A,{className:"w-5 h-5 text-orange-500"});default:return(0,s.jsx)(f.A,{className:"w-5 h-5"})}})(e.type),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium",children:e.name}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:[e.type.toUpperCase(),e.lastConnected&&(0,s.jsxs)("span",{className:"ml-2",children:["آخر اتصال:"," ",new Date(e.lastConnected).toLocaleString("ar")]})]})]})]}),(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[e.isActive?(0,s.jsx)(d.E,{className:"bg-green-500",children:"نشط"}):e.isConnected?(0,s.jsx)(d.E,{variant:"secondary",children:"متصل"}):(0,s.jsx)(d.E,{variant:"outline",children:"غير متصل"}),(0,s.jsx)(i.$,{variant:"outline",size:"sm",onClick:()=>ed(e.id),disabled:W===e.id,children:W===e.id?(0,s.jsx)(A.A,{className:"w-4 h-4 animate-spin"}):(0,s.jsx)(g.A,{className:"w-4 h-4"})}),!e.isActive&&e.isConnected&&(0,s.jsx)(i.$,{variant:"default",size:"sm",onClick:()=>em(e.id),children:"تفعيل"}),(0,s.jsx)(i.$,{variant:"ghost",size:"sm",onClick:()=>J(e),children:(0,s.jsx)(v.A,{className:"w-4 h-4"})}),(0,s.jsx)(i.$,{variant:"ghost",size:"sm",onClick:()=>eu(e.id),children:(0,s.jsx)($.A,{className:"w-4 h-4"})})]})]}),e.metadata&&(0,s.jsx)("div",{className:"mt-3 text-sm text-muted-foreground",children:(0,s.jsxs)("div",{className:"flex space-x-4",children:[e.metadata.tables&&(0,s.jsxs)("span",{children:["الجداول: ",e.metadata.tables.length]}),e.metadata.size&&(0,s.jsxs)("span",{children:["الحجم: ",ef(e.metadata.size)]}),e.metadata.version&&(0,s.jsxs)("span",{children:["الإصدار: ",e.metadata.version]})]})})]})},e.id)),0===a.length&&(0,s.jsx)(r.Zp,{children:(0,s.jsxs)(r.Wu,{className:"pt-6 text-center",children:[(0,s.jsx)(f.A,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-medium mb-2",children:"لا توجد اتصالات"}),(0,s.jsx)("p",{className:"text-muted-foreground mb-4",children:"أضف اتصال قاعدة بيانات للبدء"}),(0,s.jsxs)(i.$,{onClick:()=>Z(!0),children:[(0,s.jsx)(C.A,{className:"w-4 h-4 mr-2"}),"إضافة اتصال"]})]})})]})}),(0,s.jsx)(m.av,{value:"backups",children:(0,s.jsxs)("div",{className:"space-y-4",children:[P.map(e=>(0,s.jsx)(r.Zp,{children:(0,s.jsx)(r.Wu,{className:"pt-6",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"font-medium",children:e.name}),(0,s.jsxs)("div",{className:"text-sm text-muted-foreground space-y-1",children:[(0,s.jsxs)("p",{children:["تاريخ الإنشاء:"," ",new Date(e.createdAt).toLocaleString("ar")]}),(0,s.jsxs)("p",{children:["الحجم: ",ef(e.size)]}),(0,s.jsxs)("p",{children:["السجلات: ",e.recordCount.toLocaleString()]}),(0,s.jsxs)("p",{children:["الجداول: ",e.tables.join(", ")]})]})]}),(0,s.jsxs)("div",{className:"flex space-x-2",children:[(0,s.jsxs)(i.$,{variant:"outline",size:"sm",onClick:()=>ep(e.id),children:[(0,s.jsx)(M.A,{className:"w-4 h-4 mr-1"}),"استعادة"]}),(0,s.jsx)(i.$,{variant:"ghost",size:"sm",onClick:()=>ex(e.id),children:(0,s.jsx)($.A,{className:"w-4 h-4"})})]})]})})},e.id)),0===P.length&&(0,s.jsx)(r.Zp,{children:(0,s.jsxs)(r.Wu,{className:"pt-6 text-center",children:[(0,s.jsx)(j.A,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-medium mb-2",children:"لا توجد نسخ احتياطية"}),(0,s.jsx)("p",{className:"text-muted-foreground",children:"النسخ الاحتياطية تحمي بياناتك"})]})})]})}),(0,s.jsx)(m.av,{value:"migration",children:(0,s.jsxs)("div",{className:"space-y-4",children:[et&&(0,s.jsxs)(r.Zp,{children:[(0,s.jsx)(r.aR,{children:(0,s.jsxs)(r.ZB,{className:"flex items-center gap-2",children:[(0,s.jsx)(k.A,{className:"w-5 h-5"}),"حالة مخطط قاعدة البيانات"]})}),(0,s.jsx)(r.Wu,{children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-sm",children:"الجداول المفقودة"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-red-500",children:et.missingTables.length})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-sm",children:"الجداول المختلفة"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-yellow-500",children:et.differentTables.length})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-sm",children:"الفهارس المفقودة"}),(0,s.jsx)("p",{className:"text-2xl font-bold text-blue-500",children:et.missingIndexes.length})]})]})})]}),es&&(0,s.jsxs)(r.Zp,{children:[(0,s.jsxs)(r.aR,{children:[(0,s.jsxs)(r.ZB,{className:"flex items-center gap-2",children:[(0,s.jsx)(T.A,{className:"w-5 h-5"}),"خطة الهجرة"]}),(0,s.jsx)(r.BT,{children:es.description})]}),(0,s.jsx)(r.Wu,{children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium",children:es.name}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["من ",es.fromVersion," إلى"," ",es.toVersion]})]}),(0,s.jsx)(d.E,{variant:"low"===es.riskLevel?"default":"medium"===es.riskLevel?"secondary":(es.riskLevel,"destructive"),children:"low"===es.riskLevel?"مخاطر منخفضة":"medium"===es.riskLevel?"مخاطر متوسطة":"high"===es.riskLevel?"مخاطر عالية":"مخاطر حرجة"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-muted-foreground",children:"الوقت المتوقع"}),(0,s.jsxs)("p",{className:"font-medium",children:[es.estimatedTime," دقيقة"]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-muted-foreground",children:"عدد الهجرات"}),(0,s.jsx)("p",{className:"font-medium",children:es.migrations.length})]})]}),es.warnings.length>0&&(0,s.jsxs)("div",{className:"bg-yellow-50 p-3 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-2",children:[(0,s.jsx)(p.A,{className:"w-4 h-4 text-yellow-600"}),(0,s.jsx)("span",{className:"font-medium text-yellow-800",children:"تحذيرات"})]}),(0,s.jsx)("ul",{className:"text-sm text-yellow-700 space-y-1",children:es.warnings.map((e,t)=>(0,s.jsxs)("li",{children:["• ",e]},t))})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.$,{onClick:ey,disabled:Q,className:"flex-1",children:Q?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(A.A,{className:"w-4 h-4 mr-2 animate-spin"}),"جارٍ التنفيذ..."]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(N.A,{className:"w-4 h-4 mr-2"}),"تنفيذ الهجرة"]})}),es.backupRequired&&(0,s.jsxs)(i.$,{variant:"outline",onClick:eh,children:[(0,s.jsx)(j.A,{className:"w-4 h-4 mr-2"}),"نسخة احتياطية أولاً"]})]})]})})]}),!I&&(0,s.jsx)(r.Zp,{children:(0,s.jsxs)(r.Wu,{className:"pt-6 text-center",children:[(0,s.jsx)(T.A,{className:"w-16 h-16 mx-auto text-muted-foreground mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-medium mb-2",children:"لا يوجد اتصال نشط"}),(0,s.jsx)("p",{className:"text-muted-foreground",children:"اختر قاعدة بيانات نشطة لعرض خيارات الهجرة"})]})})]})}),(0,s.jsx)(m.av,{value:"settings",children:(0,s.jsxs)(r.Zp,{children:[(0,s.jsxs)(r.aR,{children:[(0,s.jsx)(r.ZB,{children:"إعدادات قاعدة البيانات"}),(0,s.jsx)(r.BT,{children:"الإعدادات العامة لإدار�� قاعدة البيانات"})]}),(0,s.jsxs)(r.Wu,{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(l.J,{children:"النسخ الاحتياطي التلقائي"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"إنشاء نسخة احتياطية تلقائياً كل يوم"})]}),(0,s.jsx)(u.d,{})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(l.J,{children:"مراقبة الأداء"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"تتبع أداء قاعدة البيانات والاستعلامات"})]}),(0,s.jsx)(u.d,{defaultChecked:!0})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(l.J,{children:"تنبيهات المخطط"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"إشعارات عند اكتشاف تغييرات في المخطط"})]}),(0,s.jsx)(u.d,{defaultChecked:!0})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(l.J,{children:"فترة الاحتفاظ بالنسخ ا��احتياطي"}),(0,s.jsxs)(o.l6,{defaultValue:"30",children:[(0,s.jsx)(o.bq,{className:"w-48",children:(0,s.jsx)(o.yv,{})}),(0,s.jsxs)(o.gC,{children:[(0,s.jsx)(o.eb,{value:"7",children:"7 أيام"}),(0,s.jsx)(o.eb,{value:"30",children:"30 يوم"}),(0,s.jsx)(o.eb,{value:"90",children:"90 يوم"}),(0,s.jsx)(o.eb,{value:"365",children:"سنة واحدة"})]})]})]}),(0,s.jsxs)(i.$,{children:[(0,s.jsx)(S.A,{className:"w-4 h-4 mr-2"}),"حفظ الإعدادات"]})]})]})})]}),V&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50",children:(0,s.jsxs)(r.Zp,{className:"w-full max-w-md",children:[(0,s.jsx)(r.aR,{children:(0,s.jsx)(r.ZB,{children:"إضافة اتصال جديد"})}),(0,s.jsxs)(r.Wu,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(l.J,{children:"اسم الاتصال"}),(0,s.jsx)(c.p,{value:H.name,onChange:e=>G(t=>({...t,name:e.target.value})),placeholder:"مثل: قاعدة البيانات الرئيسية"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(l.J,{children:"نوع قاعدة البيانات"}),(0,s.jsxs)(o.l6,{value:H.type,onValueChange:e=>G(t=>({...t,type:e,config:{}})),children:[(0,s.jsx)(o.bq,{children:(0,s.jsx)(o.yv,{})}),(0,s.jsxs)(o.gC,{children:[(0,s.jsx)(o.eb,{value:"supabase",children:"Supabase"}),(0,s.jsx)(o.eb,{value:"mongodb",children:"MongoDB"}),(0,s.jsx)(o.eb,{value:"firebase",children:"Firebase"})]})]})]}),"supabase"===H.type&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(l.J,{children:"رابط المشروع"}),(0,s.jsx)(c.p,{placeholder:"https://your-project.supabase.co",onChange:e=>G(t=>({...t,config:{...t.config,url:e.target.value}}))})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)(l.J,{children:"مفتاح API"}),(0,s.jsx)(c.p,{type:"password",placeholder:"مفتاح Supabase",onChange:e=>G(t=>({...t,config:{...t.config,key:e.target.value}}))})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(i.$,{onClick:eo,className:"flex-1",children:"إضافة"}),(0,s.jsx)(i.$,{variant:"outline",onClick:()=>Z(!1),children:"إلغاء"})]})]})]})})]})}}},e=>{e.O(0,[8611,1707,8096,2076,7358],()=>e(e.s=95)),_N_E=e.O()}]);